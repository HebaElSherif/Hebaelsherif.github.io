rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    // IMPORTANT: replace this email with your real admin email (lowercase)
    function isAdmin() { return signedIn() && request.auth.token.email == "YOUR_ADMIN_EMAIL_HERE"; }

    match /users/{uid} {
      allow read, write: if isOwner(uid);
    }

    match /slots/{slotId} {
      allow read: if true;

      allow create: if signedIn()
        && request.resource.data.status == "reserved"
        && request.resource.data.reservedBy == request.auth.uid;

      allow update: if isAdmin() || (
        signedIn()
        && (
          (resource.data.status == "reserved" && resource.data.reservedBy == request.auth.uid)
          ||
          (request.resource.data.status == "reserved" && request.resource.data.reservedBy == request.auth.uid)
        )
      );

      allow delete: if false;
    }

    match /bookings/{bookingId} {
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;

      allow read: if isAdmin() || (signedIn() && resource.data.uid == request.auth.uid);

      allow update: if isAdmin() || (
        signedIn()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email
      );

      allow delete: if false;
    }

    match /progressCourses/{docId} {
      allow read: if signedIn() && resource.data.uid == request.auth.uid;
      allow create, update: if signedIn() && request.resource.data.uid == request.auth.uid;
      allow delete: if false;
    }

    match /public/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
